{% extends 'base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }
    </style>
{% endblock %}

{% block body %}
    {# Statistics Cards #}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stat-card bg-primary text-white">
                <div class="card-body" onclick="window.location.href='leads'">
                    <h5 class="card-title">Tickets</h5>
                    <h2 class="card-text">{{ stats.tickets }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card bg-success text-white" onclick="window.location.href='tickets'">
                <div class="card-body">
                    <h5 class="card-title">Leads</h5>
                    <h2 class="card-text">{{ stats.leads }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card bg-info text-white" onclick="window.location.href='clients'">
                <div class="card-body">
                    <h5 class="card-title">Clients</h5>
                    <h2 class="card-text">{{ stats.clients }}</h2>
                </div>
            </div>
        </div>
    </div>

    {# Charts Row 1 #}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Priorités des Tickets</h5>
                    <div class="chart-container">
                        <canvas id="ticketPrioritiesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Budget par Client</h5>
                    <div class="chart-container">
                        <canvas id="budgetByClientChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Charts Row 2 #}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Dépenses vs Budget</h5>
                    <div class="chart-container">
                        <canvas id="expenseVsBudgetChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ticket Priorities Donut Chart
            new Chart(document.getElementById('ticketPrioritiesChart'), {
                type: 'doughnut',
                data: {
                    labels: {{ ticketPriorities|keys|json_encode|raw }},
                    datasets: [{
                        data: {{ ticketPriorities|keys|map(v => attribute(ticketPriorities, v))|json_encode|raw }},
                        backgroundColor: [
                            '#28a745', // Low
                            '#ffc107', // Medium
                            '#fd7e14', // High
                            '#dc3545', // Critical
                            '#6c757d', // Closed
                            '#9c27b0'  // Urgent
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Budget by Client Bar Chart
            new Chart(document.getElementById('budgetByClientChart'), {
                type: 'bar',
                data: {
                    labels: {{ budgetByClient|keys|json_encode|raw }},
                    datasets: [{
                        label: 'Budget',
                        data: {{ budgetByClient|keys|map(v => attribute(budgetByClient, v))|json_encode|raw }},
                        backgroundColor: '#4CAF50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Expense vs Budget Timeline
            new Chart(document.getElementById('expenseVsBudgetChart'), {
                type: 'line',
                data: {
                    labels: {{ expenseVsBudget|keys|json_encode|raw }},
                    datasets: [{
                        label: 'Dépenses',
                        data: {{ expenseVsBudget|column('expenses')|json_encode|raw }},
                        borderColor: '#dc3545',
                        fill: false
                    }, {
                        label: 'Budget',
                        data: {{ expenseVsBudget|column('budget')|json_encode|raw }},
                        borderColor: '#28a745',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
{% endblock %}
